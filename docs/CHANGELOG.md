# Change Tracking – Unreleased

## Highlights
- Проект расширен до полного конвейера обработки спортивных новостей: нормализация тегов, кластеризация историй, публикация в Telegram, веб-интерфейс и мониторинг.
- Добавлены миграции БД, объединяющие таблицы историй, очереди публикаций, дайджестов и мониторинговых логов.
- Внедрены инструменты для ручного контроля (редактирование сообщений, подсев алиасов, on-demand сбор новостей).
- Запущен FastAPI веб-приложение с шаблонами для управления историями, очередью и дайджестами.

## Документация и настройки
- `README.md` переписан: новое описание, быстрый старт, чек-лист проверок.
- Новый `docs/AGAENT_PROMPT.md` документирует промпт Codex-агента и рабочие регламенты.
- Добавлен `.env.example` с настройками Telegram, расписания, дайджестов и алертов.

## Зависимости
- `requirements.txt` расширен: добавлены aiogram/Telegram SDK, FastAPI, Jinja2, spaCy, pymorphy3, nltk, инструменты для мониторинга и документации.
- `bot/requirements.txt` содержит изолированный набор зависимостей для запуска бота отдельно.

## Работа с данными и алиасами
- Пакет `categorizer/` реализует нормализацию тегов, поиск сущностей (`alias_mapper.py`, `tag_utils.py`, `normalize.py`, `db_tags.py`, `assign_entities.py`).
- Скрипты `scripts/apply_aliases_seed.py`, `scripts/aliases_seed_from_log.py` и `mappings/aliases_seed.yml` позволяют подгружать словарь алиасов и восстанавливать их из логов.
- `scripts/alias_backfill.py` и `scripts/backfill_fingerprints.py` — утилиты для массового дообогащения БД.

## Инкрементальный парсинг Championat
- `scripts/sync_champ_news.py` переработан: управление якорями, очистка URL, Selenium-парсинг, генерация fingerprint’ов, учёт тегов и подробные логи.
- `scripts/fetch_entity_news_on_demand.py` умеет догружать новости по конкретной сущности, запускать синхронизацию и переустраивать сущности.

## Кластеризация и дедупликация
- Пакет `cluster/` (в т.ч. `build.py`, `antidup.py`, `fingerprints.py`, `title_refiner.py`, `refresh_titles.py`) группирует новости в истории, вычисляет сигнатуры и устраняет дубли.
- Схема `db/migrations/005_content_fingerprints.sql` хранит отпечатки заголовков/сущностей.

## База данных
- Миграции `db/migrations/003_stories.sql` – `009_monitor.sql` создают таблицы историй, связей, очереди публикаций, карты сообщений, дайджестов и мониторинговых логов.
- `db/utils.py` реализует единый доступ к SQLite, resolves пути и гарантирует наличие индексов.
- `scripts/db_migrate.py` применяет SQL-миграции по очереди с обработкой повторных запусков.

## Telegram-публикация и планирование
- Пакет `bot/`:
  - `publish.py`, `publisher.py`, `sender.py` — рендеринг сообщений, отправка историй/статей, разбиение по лимитам.
  - `edit.py` — редактирование или добавление обновлений к уже опубликованным постам.
  - `schedule.py`, `scheduler.py` — очередь публикации, учёт тихих часов и rate-limit’ов.
- Скрипты `scripts/run_webapp_bot.py`, `scripts/digest.py`, `scripts/monitor.py` подключают бота к веб-интерфейсу, формируют дайджесты и собирают метрики.

## Веб-приложение
- Пакет `webapp/` (FastAPI + Jinja2) даёт UI для просмотра историй, очереди, дайджестов и публикации:
  - `webapp/main.py` — API и HTML-страницы, базовая авторизация, интеграция с Telegram.
  - `webapp/digest_service.py`, `webapp/digest_render.py` — формирование и отправка дайджестов.
  - Шаблоны и стили (`webapp/templates/*.html`, `webapp/static/style.css`) предоставляют интерфейс.

## Мониторинг и алерты
- `scripts/monitor.py` собирает метрики, сохраняет их в `monitor_logs` и отправляет алерты в Telegram при отклонениях.
- Переменные окружения `ALERT_*` в `.env.example` задают пороги и каналы уведомлений.

## Прочие изменения
- Создан `changes_after_last_commit.patch` — полный патч текущих правок (для переноса на другие окружения).
- Добавлены вспомогательные файлы `bot/__init__.py`, `webapp/__init__.py`, `cluster/__init__.py`, `categorizer/__init__.py` для корректной работы пакетов Python.
- Структура проекта теперь включает директории `bot/`, `categorizer/`, `cluster/`, `db/`, `mappings/`, `scripts/`, `webapp/`, расширяя возможности разработки и эксплуатации.

