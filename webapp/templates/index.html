{% extends "base.html" %}
{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
    <h1 class="h3 mb-2 mb-lg-0">–ò—Å—Ç–æ—Ä–∏–∏</h1>
    <div class="text-muted small">–ù–∞–π–¥–µ–Ω–æ: {{ pagination.total }}</div>
</div>

<form class="row g-3 align-items-end mb-4" method="get">
    <input type="hidden" name="page" value="1">
    <div class="col-12 col-md-4 col-lg-3">
        <label class="form-label" for="q">–ü–æ–∏—Å–∫ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É</label>
        <input class="form-control" type="search" id="q" name="q" value="{{ filters.q }}" placeholder="–æ–≤–µ—á–∫–∏–Ω, –ø–ª–µ–π-–æ—Ñ—Ñ‚Ä¶">
    </div>
    <div class="col-6 col-md-3 col-lg-2">
        <label class="form-label" for="sport">–í–∏–¥ —Å–ø–æ—Ä—Ç–∞</label>
        <select class="form-select" id="sport" name="sport">
            <option value="">–õ—é–±–æ–π</option>
            {% for value, name, count in entity_options.sport %}
                <option value="{{ value }}" {% if filters.sport == value %}selected{% endif %}>{{ name }} ({{ count }})</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-6 col-md-3 col-lg-2">
        <label class="form-label" for="tournament">–¢—É—Ä–Ω–∏—Ä</label>
        <select class="form-select" id="tournament" name="tournament">
            <option value="">–õ—é–±–æ–π</option>
            {% for value, name, count in entity_options.tournament %}
                <option value="{{ value }}" {% if filters.tournament == value %}selected{% endif %}>{{ name }} ({{ count }})</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-6 col-md-3 col-lg-2">
        <label class="form-label" for="team">–ö–æ–º–∞–Ω–¥–∞</label>
        <select class="form-select" id="team" name="team">
            <option value="">–õ—é–±–∞—è</option>
            {% for value, name, count in entity_options.team %}
                <option value="{{ value }}" {% if filters.team == value %}selected{% endif %}>{{ name }} ({{ count }})</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-6 col-md-3 col-lg-2">
        <label class="form-label" for="player">–ò–≥—Ä–æ–∫</label>
        <select class="form-select" id="player" name="player">
            <option value="">–õ—é–±–æ–π</option>
            {% for value, name, count in entity_options.player %}
                <option value="{{ value }}" {% if filters.player == value %}selected{% endif %}>{{ name }} ({{ count }})</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-6 col-md-3 col-lg-2">
        <label class="form-label" for="since">–û–±–Ω–æ–≤–ª–µ–Ω–æ —Å</label>
        <input class="form-control" type="text" id="since" name="since" value="{{ filters.since }}" placeholder="2025-10-10T00:00:00">
    </div>
    <div class="col-6 col-md-3 col-lg-2">
        <label class="form-label" for="until">–û–±–Ω–æ–≤–ª–µ–Ω–æ –ø–æ</label>
        <input class="form-control" type="text" id="until" name="until" value="{{ filters.until }}" placeholder="2025-10-17T23:59:59">
    </div>
    <div class="col-6 col-md-3 col-lg-2">
        <label class="form-label" for="has_neardups">–ü–æ—á—Ç–∏ –¥—É–±–ª–∏</label>
        <select class="form-select" id="has_neardups" name="has_neardups">
            <option value="" {% if not filters.has_neardups_value %}selected{% endif %}>–õ—é–±—ã–µ</option>
            <option value="true" {% if filters.has_neardups_value == 'true' %}selected{% endif %}>–ï—Å—Ç—å —Å–∫—Ä—ã—Ç—ã–µ</option>
            <option value="false" {% if filters.has_neardups_value == 'false' %}selected{% endif %}>–ë–µ–∑ –¥—É–±–ª–µ–π</option>
        </select>
    </div>
    <div class="col-6 col-md-3 col-lg-2">
        <label class="form-label" for="in_queue">–í –æ—á–µ—Ä–µ–¥–∏</label>
        <select class="form-select" id="in_queue" name="in_queue">
            <option value="" {% if not filters.in_queue_value %}selected{% endif %}>–õ—é–±—ã–µ</option>
            <option value="true" {% if filters.in_queue_value == 'true' %}selected{% endif %}>–¢–æ–ª—å–∫–æ –≤ –æ—á–µ—Ä–µ–¥–∏</option>
            <option value="false" {% if filters.in_queue_value == 'false' %}selected{% endif %}>–¢–æ–ª—å–∫–æ –≤–Ω–µ –æ—á–µ—Ä–µ–¥–∏</option>
        </select>
    </div>
    <div class="col-6 col-md-3 col-lg-2">
        <label class="form-label" for="sort">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
        <select class="form-select" id="sort" name="sort">
            {% for value, label in sort_options.items() %}
                <option value="{{ value }}" {% if filters.sort == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-6 col-md-3 col-lg-2">
        <label class="form-label" for="per_page">–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ</label>
        <input class="form-control" type="number" id="per_page" name="per_page" value="{{ filters.per_page }}" min="5" max="100">
    </div>
    <div class="col-auto">
        <button class="btn btn-primary" type="submit">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    </div>
    <div class="col-auto">
        <a class="btn btn-outline-secondary" href="/">–°–±—Ä–æ—Å–∏—Ç—å</a>
    </div>
</form>

{% if stories %}
<table class="table table-hover align-middle">
    <thead>
        <tr>
            <th style="width: 5%;">ID</th>
            <th>–ò—Å—Ç–æ—Ä–∏—è</th>
            <th style="width: 12%;">–û–±–Ω–æ–≤–ª–µ–Ω–æ</th>
            <th style="width: 15%;">–°—Ç–∞—Ç—É—Å</th>
            <th class="text-end" style="width: 18%;">–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
    </thead>
    <tbody>
    {% for story in stories %}
        <tr>
            <td class="fw-semibold">{{ story.id }}</td>
            <td>
                <a href="/stories/{{ story.id }}" class="link-dark text-decoration-none fw-semibold">{{ story.title_highlighted | safe }}</a>
                <div class="mt-2 d-flex flex-wrap gap-2">
                    <span class="badge bg-secondary-subtle text-secondary-emphasis">üì∞ {{ story.article_count }}</span>
                    {% for badge in story.badges %}
                        <span class="badge bg-light text-dark">{{ badge.icon }} {{ badge.count }}</span>
                    {% endfor %}
                    {% if story.has_neardups %}
                        <span class="badge bg-warning text-dark" title="–í –∏—Å—Ç–æ—Ä–∏–∏ —Å–∫—Ä—ã—Ç—ã –ø–æ—á—Ç–∏ –¥—É–±–ª–∏–∫–∞—Ç—ã">‚âà –¥—É–±–ª–∏</span>
                    {% endif %}
                    {% if story.in_queue %}
                        <span class="badge bg-info text-dark" title="–ò—Å—Ç–æ—Ä–∏—è —É–∂–µ –≤ –æ—á–µ—Ä–µ–¥–∏ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É">queue</span>
                    {% endif %}
                </div>
            </td>
            <td class="text-muted small">{{ story.updated_at }}</td>
            <td>
                {% if story.in_queue %}
                    <span class="badge bg-info text-dark">–í –æ—á–µ—Ä–µ–¥–∏</span>
                {% else %}
                    <span class="badge bg-light text-dark">–°–≤–æ–±–æ–¥–Ω–∞</span>
                {% endif %}
                {% if story.has_neardups %}
                    <span class="badge bg-warning text-dark ms-1">‚âà</span>
                {% endif %}
            </td>
            <td class="text-end">
                <button class="btn btn-sm btn-outline-primary me-2" onclick="previewStory({{ story.id }})">Preview</button>
                <button class="btn btn-sm btn-success" onclick="publishStory({{ story.id }}, false)">Publish now</button>
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>

<nav aria-label="pagination">
    <ul class="pagination">
        <li class="page-item {% if not pagination.prev_url %}disabled{% endif %}">
            <a class="page-link" href="{{ pagination.prev_url if pagination.prev_url else '#' }}">–ù–∞–∑–∞–¥</a>
        </li>
        {% for item in pagination.page_links %}
            <li class="page-item {% if item.current %}active{% endif %}">
                <a class="page-link" href="{{ item.url }}">{{ item.page }}</a>
            </li>
        {% endfor %}
        <li class="page-item {% if not pagination.next_url %}disabled{% endif %}">
            <a class="page-link" href="{{ pagination.next_url if pagination.next_url else '#' }}">–í–ø–µ—Ä—ë–¥</a>
        </li>
    </ul>
</nav>
{% else %}
<p class="text-muted">–ü–æ —Ç–µ–∫—É—â–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Å–ª–∞–±–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã.</p>
{% endif %}
{% endblock %}
